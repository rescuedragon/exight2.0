name: Deploy to Testing Environment (testing.exight.in)

on:
  push:
    branches: [ testing ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-to-testing:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Clean previous builds
      run: rm -rf node_modules dist .cache
      
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Add 404.html for SPA routing
      run: cp ./dist/index.html ./dist/404.html
      
    - name: Add testing build marker
      run: |
        echo "<!-- TESTING BUILD: $(date) -->" >> ./dist/index.html
        echo "<!-- Build ID: $(date +%s) -->" >> ./dist/index.html
        echo "<!-- Hash: $GITHUB_SHA -->" >> ./dist/index.html
      
    - name: Upload dist to testing server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.TEST_HOST }}
        username: ${{ secrets.TEST_USERNAME }}
        key: ${{ secrets.TEST_SSH_KEY }}
        port: ${{ secrets.TEST_SSH_PORT }}
        source: "dist/*"
        target: "/tmp/exight_testing_dist"

    - name: Deploy to testing Apache
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TEST_HOST }}
        username: ${{ secrets.TEST_USERNAME }}
        key: ${{ secrets.TEST_SSH_KEY }}
        port: ${{ secrets.TEST_SSH_PORT }}
        script_stop: true
        script: |
          set -euo pipefail

          echo "==> Removing any redirect rules for testing.exight.in"
          sudo rm -f /etc/httpd/conf.d/redirect-testing.conf || true

          echo "==> Detecting Apache DocumentRoot for testing.exight.in"
          DOCROOT=$(sudo bash -lc 'grep -Ri "ServerName\\s\+testing\\.exight\\.in" -n /etc/httpd/conf* -R | cut -d: -f1 | sort -u | head -n1 | xargs -r grep -i "DocumentRoot" -n | awk '{print $NF}' | head -n1') || true
          if [ -z "${DOCROOT:-}" ]; then
            # Create a specific directory for testing
            DOCROOT="/var/www/testing.exight.in"
          fi
          echo "Using DocumentRoot: $DOCROOT"
          sudo mkdir -p "$DOCROOT"

          echo "==> Backing up current testing site"
          TS=$(date +%s)
          sudo mkdir -p /var/www/backups
          if [ -d "$DOCROOT" ]; then
            sudo tar -C "$DOCROOT" -czf "/var/www/backups/testing_${TS}.tar.gz" . || true
          fi

          echo "==> Deploying to testing"
          sudo rm -rf "$DOCROOT"/*
          sudo cp -a /tmp/exight_testing_dist/dist/. "$DOCROOT"/

          echo "==> Setting permissions"
          sudo chown -R root:root "$DOCROOT"
          sudo find "$DOCROOT" -type d -exec chmod 755 {} +
          sudo find "$DOCROOT" -type f -exec chmod 644 {} +

          echo "==> Validating Apache config and reloading"
          sudo apachectl configtest
          sudo systemctl reload httpd || sudo service httpd reload

          echo "==> Testing deployment complete!"
          echo "ğŸŒ Live at: https://testing.exight.in"
          curl -I -s https://testing.exight.in | sed -n '1,5p'
        
    - name: Notify deployment completion
      run: |
        echo "ğŸ‰ Deployment to testing.exight.in completed!"
        echo "ğŸ“± Complete restored login functionality deployed:"
        echo "  âœ… Split layout (40% auth + 60% promotional features)"
        echo "  âœ… AuthForm with Login/Register tabs"
        echo "  âœ… PromotionalFeatures with popup modals"  
        echo "  âœ… 'Get Started' button transitions"
        echo "  âœ… Apple-inspired typography and animations"
        echo "  âœ… Clickable feature cards"
        echo "  âœ… GoogleAuthButton with official branding"
        echo "ğŸŒ Live at: https://testing.exight.in"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
