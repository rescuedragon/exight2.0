name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Predeploy checks
        run: |
          echo "üîç Running predeploy checks..."

          # Run linting
          echo "üìù Running ESLint..."
          npm run lint

          # Run tests if they exist
          if npm run | grep -q "test"; then
            echo "üß™ Running tests..."
            npm test
          else
            echo "‚ö†Ô∏è  No test script found, skipping tests"
          fi

          echo "‚úÖ Predeploy checks completed"

      - name: Inject frontend env (prod)
        run: |
          echo "VITE_API_BASE_URL=https://exight.in/api" >> .env
          if [ -n "${{ secrets.PROD_GOOGLE_CLIENT_ID }}" ]; then
            echo "VITE_GOOGLE_CLIENT_ID=${{ secrets.PROD_GOOGLE_CLIENT_ID }}" >> .env
          fi
          echo "‚úÖ Wrote .env for build"

      - name: Build app
        run: npm run build

      - name: List build output
        run: ls -la dist/

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            # Backup current files
            sudo cp -r /var/www/html /var/www/html.backup.$(date +%Y%m%d_%H%M%S)

            # Remove old frontend files completely to avoid stale hashed asset refs
            sudo rm -rf /var/www/html/*

            # Set proper permissions for upload
            sudo chown -R ec2-user:ec2-user /var/www/html/
            sudo chmod -R 755 /var/www/html/

      - name: Upload files
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          source: 'dist/*'
          target: '/var/www/html/'
          strip_components: 0

      - name: Clean up and set permissions
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            # Remove any nested dist folder if created
            if [ -d "/var/www/html/dist" ]; then
              sudo mv /var/www/html/dist/* /var/www/html/ 2>/dev/null || true
              sudo rm -rf /var/www/html/dist
            fi

            # Set final permissions
            sudo chown -R ec2-user:apache /var/www/html/
            sudo chmod -R 750 /var/www/html/
            sudo chmod -R g+rx /var/www/html/

            # Restart backend if needed
            sudo systemctl restart exight-backend.service

            # Verify files are in correct location
            echo "Files in /var/www/html/:"
            ls -la /var/www/html/

      - name: Restart Services
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            # Restart backend service if it exists
            if sudo systemctl is-enabled exight-backend.service &>/dev/null; then
              sudo systemctl restart exight-backend.service
              echo "‚úÖ Backend service restarted"
            else
              echo "‚ö†Ô∏è  Backend service not found, skipping restart"
            fi
            
            # Restart Apache to ensure proper serving
                sudo systemctl restart httpd
            echo "‚úÖ Apache restarted"
