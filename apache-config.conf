<VirtualHost *:80>
    ServerName 13.60.70.116
    DocumentRoot /var/www/html
    
    # Enable mod_rewrite
    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Handle React Router - serve index.html for all routes
        RewriteEngine On
        RewriteBase /
        
        # If the request is for a file or directory that exists, serve it
        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        
        # Otherwise, serve index.html (React Router will handle the routing)
        RewriteRule ^ index.html [L]
    </Directory>
    
    # Handle API requests to the backend
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api
    
    # Logs
    ErrorLog ${APACHE_LOG_DIR}/exight_error.log
    CustomLog ${APACHE_LOG_DIR}/exight_access.log combined

    # Static asset caching
    <IfModule mod_expires.c>
        ExpiresActive On
        # Default: minimal cache
        ExpiresDefault "access plus 1 hour"
        # HTML should not be cached aggressively (SPA entry)
        ExpiresByType text/html "access plus 0 seconds"
        # Long cache for static assets
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/webp "access plus 1 year"
        ExpiresByType image/avif "access plus 1 year"
        ExpiresByType image/x-icon "access plus 1 year"
        ExpiresByType application/json "access plus 1 hour"
    </IfModule>

    <IfModule mod_headers.c>
        # Immutable cache for hashed assets (Vite outputs content-hashed filenames)
        <FilesMatch "\.(?:js|css|svg|png|jpe?g|gif|webp|avif|ico)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>
        # JSON and API-like static files short cache
        <FilesMatch "\.(?:json)$">
            Header set Cache-Control "public, max-age=3600"
        </FilesMatch>
        # HTML should be revalidated frequently to pick up new bundles
        <FilesMatch "\.(?:html)$">
            Header set Cache-Control "no-cache"
        </FilesMatch>
    </IfModule>

    # Enable ETag based on mtime + size
    FileETag MTime Size
</VirtualHost> 

# --- Optional production HTTPS enforcement and HSTS (enable on servers with TLS) ---
# To enable, ensure you have a valid :443 vhost with certificates configured
# and then uncomment the redirect and header lines below in the :80 vhost,
# or move them into your :443 vhost as appropriate.
#
# Requirements:
# - a2enmod rewrite headers ssl
# - Valid SSLCertificateFile/KeyFile set in your :443 vhost
#
# Example snippets (COMMENTED OUT by default to avoid breaking dev):
#
# <IfModule mod_rewrite.c>
#   RewriteEngine On
#   # Redirect all HTTP to HTTPS
#   RewriteCond %{HTTPS} !=on
#   RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>
#
# <IfModule mod_headers.c>
#   # Add HSTS header on HTTPS responses (1 year, include subdomains, preload)
#   # ONLY enable after confirming HTTPS works for all subdomains
#   Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
# </IfModule>
